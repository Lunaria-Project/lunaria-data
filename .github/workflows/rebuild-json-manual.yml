name: Rebuild JSON (manual - full)

on:
  workflow_dispatch:
    inputs:
      reason:
        description: "Why are you rebuilding?"
        required: false
        default: ""

permissions:
  contents: read

env:
  JSON_REPO: Lunaria-Project/lunaria-data-json
  JSON_BRANCH: main
  JSON_SUBDIR: data
  META_DIR: _meta
  ID_MAP_BASENAME: id_map.json

  LOCALDATA_XLSX_BASENAME: LocalData.xlsx
  LOCALDATA_JSON_WORKSPACE_PATH: data/LocalData/LocalData.json
  LOCALDATA_JSON_BASENAME: LocalData.json

jobs:
  rebuild:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          set -euxo pipefail
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Force full scan (all data files)
        run: |
          set -euxo pipefail
          git ls-files | grep -E '\.(xlsx|xlsm|xls|csv)$' > changed.txt || true
          if [ ! -s changed.txt ]; then
            git ls-files > changed.txt
          fi

          echo "GIT_DIFF_FILES<<EOF" >> "$GITHUB_ENV"
          cat changed.txt >> "$GITHUB_ENV"
          echo "EOF" >> "$GITHUB_ENV"

          echo "[debug] full scan targets (top 100):"
          head -n 100 changed.txt || true

      - name: Prefetch id_map.json from JSON repo (if exists)
        env:
          GH_TOKEN: ${{ secrets.LUNARIA_PAT }}
        run: |
          set -euxo pipefail
          rm -rf prefetch
          mkdir -p prefetch
          cd prefetch
          git init
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ env.JSON_REPO }}.git"

          if git ls-remote --exit-code --heads origin "${{ env.JSON_BRANCH }}"; then
            git fetch origin "${{ env.JSON_BRANCH }}" --depth=1
            git checkout -B "${{ env.JSON_BRANCH }}" FETCH_HEAD

            if [ -f "${{ env.JSON_SUBDIR }}/${{ env.META_DIR }}/${{ env.ID_MAP_BASENAME }}" ]; then
              cp "${{ env.JSON_SUBDIR }}/${{ env.META_DIR }}/${{ env.ID_MAP_BASENAME }}" ../id_map.json
              echo "[prefetch] brought id_map.json → $(realpath ../id_map.json)"
            else
              echo "[prefetch] no existing id_map.json in JSON repo"
            fi
          else
            echo "[prefetch] JSON branch not found; skipping"
          fi

      - name: Rebuild all JSON + LocalData (full)
        env:
          GIT_DIFF_FILES: ${{ env.GIT_DIFF_FILES }}
          ID_START: "1000000"
        run: |
          set -euxo pipefail

          python scripts/convert_xlsx_to_json.py

          python scripts/localdata_from_json.py \
            --json_dir json \
            --out_xlsx "${{ env.LOCALDATA_XLSX_BASENAME }}" \
            --out_json "${{ env.LOCALDATA_JSON_BASENAME }}"

          echo "[debug] LocalData.xlsx presence:"
          [ -f "${{ env.LOCALDATA_XLSX_BASENAME }}" ] && ls -l "${{ env.LOCALDATA_XLSX_BASENAME }}" || echo "LocalData.xlsx NOT FOUND"

          echo "[debug] LocalData.json presence:"
          [ -f "${{ env.LOCALDATA_JSON_WORKSPACE_PATH }}" ] && ls -l "${{ env.LOCALDATA_JSON_WORKSPACE_PATH }}" || echo "${{ env.LOCALDATA_JSON_WORKSPACE_PATH }} NOT FOUND"

          echo "[debug] LocalData.warnings presence:"
          [ -f LocalData.warnings.txt ] && ls -l LocalData.warnings.txt || echo "LocalData.warnings.txt NOT FOUND"

      - name: Prepare JSON target repo
        env:
          GH_TOKEN: ${{ secrets.LUNARIA_PAT }}
        run: |
          set -euxo pipefail
          rm -rf json-repo
          mkdir -p json-repo
          cd json-repo
          git init
          git config user.name "json-export-bot"
          git config user.email "json-export-bot@users.noreply.github.com"
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ env.JSON_REPO }}.git"

          if git ls-remote --exit-code --heads origin "${{ env.JSON_BRANCH }}"; then
            git fetch origin "${{ env.JSON_BRANCH }}" --depth=1
            git checkout -B "${{ env.JSON_BRANCH }}" FETCH_HEAD
          else
            git checkout --orphan "${{ env.JSON_BRANCH }}"
            echo "{}" > .init.json
            git add .init.json
            git commit -m "chore: initialize branch"
            git push -u origin "${{ env.JSON_BRANCH }}"
          fi

      - name: Copy, commit & push (full sync)
        working-directory: json-repo
        shell: bash
        env:
          GH_TOKEN: ${{ secrets.LUNARIA_PAT }}
        run: |
          set -euxo pipefail
          git config --global --add safe.directory "$PWD"

          mkdir -p "${JSON_SUBDIR}"
          shopt -s nullglob

          # 1) json 폴더 전체 동기화 (delete 포함)
          for d in ../json/*/ ; do
            base="$(basename "$d")"
            mkdir -p "${JSON_SUBDIR}/${base}"
            rsync -a --delete "${d}" "${JSON_SUBDIR}/${base}/"
          done

          for f in ../json/*.json ; do
            rsync -a "${f}" "${JSON_SUBDIR}/"
          done

          # 2) id_map.json -> data/_meta/id_map.json
          if [ -f ../id_map.json ]; then
            mkdir -p "${JSON_SUBDIR}/${META_DIR}"
            cp ../id_map.json "${JSON_SUBDIR}/${META_DIR}/${ID_MAP_BASENAME}"
            echo "[copy] wrote ${JSON_SUBDIR}/${META_DIR}/${ID_MAP_BASENAME}"
          else
            echo "[copy] id_map.json missing; nothing to copy"
          fi

          # 3) LocalData.xlsx -> data/_meta/LocalData.xlsx
          if [ -f "../${LOCALDATA_XLSX_BASENAME}" ]; then
            mkdir -p "${JSON_SUBDIR}/${META_DIR}"
            cp "../${LOCALDATA_XLSX_BASENAME}" "${JSON_SUBDIR}/${META_DIR}/${LOCALDATA_XLSX_BASENAME}"
            echo "[copy] wrote ${JSON_SUBDIR}/${META_DIR}/${LOCALDATA_XLSX_BASENAME}"
          else
            echo "[copy] LocalData.xlsx missing; nothing to copy"
          fi

          # 4) LocalData.json -> data/LocalData/LocalData.json
          if [ -f "../${LOCALDATA_JSON_WORKSPACE_PATH}" ]; then
            mkdir -p "${JSON_SUBDIR}/LocalData"
            cp "../${LOCALDATA_JSON_WORKSPACE_PATH}" "${JSON_SUBDIR}/LocalData/LocalData.json"
            echo "[copy] wrote ${JSON_SUBDIR}/LocalData/LocalData.json"
          else
            echo "[copy] LocalData.json missing: ../${LOCALDATA_JSON_WORKSPACE_PATH}"
            (cd .. && find . -maxdepth 4 -name "LocalData.json" -print) || true
          fi

          # 5) warnings -> data/_meta/LocalData.warnings.txt
          if [ -f ../LocalData.warnings.txt ]; then
            mkdir -p "${JSON_SUBDIR}/${META_DIR}"
            cp ../LocalData.warnings.txt "${JSON_SUBDIR}/${META_DIR}/LocalData.warnings.txt"
            echo "[copy] wrote ${JSON_SUBDIR}/${META_DIR}/LocalData.warnings.txt"
          else
            echo "[copy] LocalData.warnings.txt missing; nothing to copy"
          fi

          echo "[debug] status:"
          git status --porcelain | head -n 200 || true

          if [ -n "$(git status --porcelain)" ]; then
            git add -A

            reason="${{ github.event.inputs.reason }}"
            if [ -n "${reason}" ]; then
              git commit -m "[${{ github.actor }}] : manual full rebuild - ${reason}"
            else
              git commit -m "[${{ github.actor }}] : manual full rebuild"
            fi

            git push origin "HEAD:${{ env.JSON_BRANCH }}"
          else
            echo "No changes to push."
          fi
