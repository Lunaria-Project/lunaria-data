name: XLSX to JSON (export to external repo)

on:
  push:
    paths:
      - "**/*.xlsx"
      - "**/*.xlsm"
      - "**/*.xls"
      - "**/*.csv"
      - "scripts/convert_xlsx_to_json.py"
      - "requirements.txt"
  pull_request:
    paths:
      - "**/*.xlsx"
      - "**/*.xlsm"
      - "**/*.xls"
      - "**/*.csv"
      - "scripts/convert_xlsx_to_json.py"
      - "requirements.txt"

permissions:
  contents: read

env:
  JSON_REPO: Lunaria-Project/lunaria-data-json   # 결과 저장용 레포
  JSON_BRANCH: main                              # 타깃 브랜치
  JSON_SUBDIR: data                              # 타깃 레포에서 저장할 하위 폴더

jobs:
  export:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout source
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: Install deps
        run: |
          python -m pip install --upgrade pip
          pip install -r requirements.txt

      - name: Collect changed files (robust)
        run: |
          set -euxo pipefail
          : > changed.txt

          if [ "${{ github.event_name }}" = "push" ]; then
            echo "[push] collect changed files"
            PARENT="$(git rev-parse '${{ github.sha }}^' 2>/dev/null || true)"
            if [ -n "$PARENT" ]; then
              git diff --name-only "$PARENT" '${{ github.sha }}' > changed.txt || true
            fi
            if [ ! -s changed.txt ]; then
              echo "[fallback] no parent or diff failed -> list all tracked files"
              git ls-files > changed.txt
            fi

          elif [ "${{ github.event_name }}" = "pull_request" ]; then
            echo "[pr] collect changed files vs base"
            git fetch origin '${{ github.base_ref }}' --depth=0
            git diff --name-only "origin/${{ github.base_ref }}...HEAD" > changed.txt || true
            if [ ! -s changed.txt ]; then
              echo "[fallback] diff failed -> list all tracked files"
              git ls-files > changed.txt
            fi

          else
            echo "[other] list all tracked files"
            git ls-files > changed.txt
          fi

          echo "GIT_DIFF_FILES<<EOF" >> $GITHUB_ENV
          cat changed.txt >> $GITHUB_ENV
          echo "EOF" >> $GITHUB_ENV

          echo "Changed files:"; cat changed.txt

          # ✅ 데이터 파일이 전혀 없으면 전체 스캔 강제 (스크립트/경로만 수정된 경우 대비)
          if ! grep -E '\.(xlsx|xlsm|xls|csv)$' changed.txt >/dev/null 2>&1; then
            echo "[info] no data file changed -> force full scan"
            git ls-files > changed.txt
            echo "GIT_DIFF_FILES<<EOF" >> $GITHUB_ENV
            cat changed.txt >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi

      - name: Run converter
        env:
          GIT_DIFF_FILES: ${{ env.GIT_DIFF_FILES }}
        run: |
          python scripts/convert_xlsx_to_json.py
          echo "[debug] json directory:"
          ls -R json || true

      - name: Upload artifact (PR only)
        if: ${{ github.event_name == 'pull_request' }}
        uses: actions/upload-artifact@v4
        with:
          name: json-output
          path: json

      # JSON 타깃 레포를 수동으로 준비 + 상세 로그
      - name: Prepare JSON target repo
        if: ${{ github.event_name == 'push' }}
        env:
          GH_TOKEN: ${{ secrets.JSON_REPO_TOKEN }}
        run: |
          set -euxo pipefail
          rm -rf json-repo
          mkdir -p json-repo
          cd json-repo
          git init
          git config user.name "json-export-bot"
          git config user.email "json-export-bot@users.noreply.github.com"
          git remote add origin "https://x-access-token:${GH_TOKEN}@github.com/${{ env.JSON_REPO }}.git"

          echo "[debug] remotes:"
          git remote -v
          echo "[debug] ls-remote heads:"
          git ls-remote --heads origin || true

          if git ls-remote --exit-code --heads origin ${{ env.JSON_BRANCH }}; then
            echo "[info] target branch exists -> fetch & checkout"
            git fetch origin ${{ env.JSON_BRANCH }} --depth=1
            git checkout -B ${{ env.JSON_BRANCH }} FETCH_HEAD
          else
            echo "[info] target branch missing -> create orphan"
            git checkout --orphan ${{ env.JSON_BRANCH }}
            echo "{}" > .init.json
            git add .init.json
            git commit -m "chore: initialize branch"
            git push -u origin ${{ env.JSON_BRANCH }}
          fi

          echo "[debug] current branch:"
          git branch -vv

      - name: Copy, commit & push JSON to target repo
        if: ${{ github.event_name == 'push' }}
        working-directory: json-repo
        env:
          GH_TOKEN: ${{ secrets.JSON_REPO_TOKEN }}
        run: |
          set -euxo pipefail
          rsync -a --delete ../json/ "${{ env.JSON_SUBDIR }}/" || true

          echo "[debug] status before commit:"
          git status
          git diff --stat || true

          if [ -n "$(git status --porcelain)" ]; then
            git add -A
            # 커밋 메시지: [작성자] : 소스 커밋 첫 줄
            AUTHOR="${{ github.event.head_commit.author.name }}"
            MSG="$(printf "%s" "${{ github.event.head_commit.message }}" | head -n 1 | tr -d '\r')"
            git commit -m "[${AUTHOR}] : ${MSG}"
            echo "[debug] pushing to JSON repo"
            git push origin HEAD:${{ env.JSON_BRANCH }}
          else
            echo "No changes to push."
          fi
